---
import { getCollection, getEntryBySlug } from 'astro:content';

export async function getStaticPaths() {
  const entries = await getCollection('news', ({ data }) => !data.draft);
  return entries.map(({ slug }) => ({ params: { slug } }));
}

const { slug } = Astro.params;
const entry = await getEntryBySlug('news', slug);
if (!entry) throw new Error('Not found');

const { Content } = await entry.render();
const { data } = entry;

const more = (await getCollection('news', ({ data: d }) => d.lang === data.lang && entry.slug !== slug && !d.draft))
  .sort((a,b) => +new Date(b.data.date) - +new Date(a.data.date))
  .slice(0,3);
---

<html lang={data.lang}>
  <head>
    <title>{data.title} – Basola</title>
    <meta name="description" content={data.summary} />
    <meta property="og:title" content={data.title} />
    <meta property="og:description" content={data.summary} />
    <link rel="icon" type="image/png" href="/assets/basola_favicon.png" />

    {data.heroImage && <meta property="og:image" content={data.heroImage} />}
    <script type="application/ld+json">
      {JSON.stringify({
        '@context':'https://schema.org',
        '@type':'NewsArticle',
        headline: data.title,
        datePublished: data.date,
        description: data.summary,
        image: data.heroImage ? [data.heroImage] : undefined,
        inLanguage: data.lang
      })}
    </script>
  </head>
  <body class="bg-neutral-50">
    <article class="mx-auto max-w-3xl px-6 py-16">
      <header class="mb-6">
        <a href={`/news?lang=${data.lang}`} class="text-sm text-basola-brown/70 hover:text-basola-brown">← Zur Übersicht</a>
        <h1 class="mt-2 text-3xl md:text-4xl font-extrabold text-basola-brown">{data.title}</h1>
        <time class="mt-2 block text-sm text-basola-brown/60">{new Date(data.date).toLocaleDateString()}</time>
        <div class="mt-3 flex flex-wrap gap-2">
          {data.tags?.map((t) => <span class="rounded-full border border-basola-yellow/70 px-2 py-0.5 text-[11px] text-basola-brown bg-white/60">{t}</span>)}
        </div>
        {data.heroImage && (
          <>
            <img src={data.heroImage} alt="" class="mt-6 rounded-xl ring-1 ring-black/5 bg-white p-2" />
            {data.heroImageCaption && (
              <p class="mt-2 text-sm text-basola-brown/60">{data.heroImageCaption}</p>
            )}
          </>
        )}
      </header>

      <div class="prose prose-neutral max-w-none prose-headings:text-basola-brown prose-a:text-basola-brown hover:prose-a:text-basola-yellow">
        <Content />
      </div>

      {data.externalUrl && (
        <a href={data.externalUrl} target="_blank" rel="noopener" class="mt-8 inline-flex items-center gap-2 rounded-xl border border-basola-yellow px-4 py-2 font-semibold text-basola-brown hover:bg-white">
          Zum Artikel <span aria-hidden>↗</span>
        </a>
      )}
    </article>

    {more.length > 0 && (
      <section class="mx-auto max-w-6xl px-6 pb-16">
        <h2 class="text-xl font-bold text-basola-brown mb-4">Weitere Updates</h2>
        <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
          {more.map(({ slug, data }) => (
            <a href={`/news/${slug}`} class="rounded-xl bg-white ring-1 ring-black/5 p-4 hover:shadow-md transition">
              <div class="text-sm text-basola-brown/60">{new Date(data.date).toLocaleDateString()}</div>
              <div class="mt-1 font-semibold text-basola-brown">{data.title}</div>
            </a>
          ))}
        </div>
      </section>
    )}
  </body>
</html>
