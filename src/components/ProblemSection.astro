---
interface KPI { id: string; value: number; suffix: string; label: string; }
interface FlowCard { icon: string; title: string; text: string; }

const {
  heading = 'Das Problem ‚Äì wenn niemand abholt',
  subline = 'In Orten wie Ladrilleros (nur per Boot erreichbar) gibt es keine M√ºllabfuhr: Plastik wird offen verbrannt oder abgelagert ‚Äì das belastet Luft, Meer & Gesundheit.',
  kpis = [
    { id: 'k1', value: 100, suffix: ' kg/Tag', label: 'Plastikabfall (lokal)' },
    { id: 'k2', value: 86, suffix: ' kg CO‚ÇÇ/Tag', label: 'CO‚ÇÇ vermeidbar (offenes Verbrennen)' },
    { id: 'k3', value: 40, suffix: ' L/Tag', label: 'Diesel ersetzbar (lokal genutzt)' },
  ] as KPI[],
  flow = [
    { icon: 'üóëÔ∏è', title: 'Kein Abholsystem', text: 'Kein Zugang zu geregelter Entsorgung; Plastik sammelt sich.' },
    { icon: 'üî•', title: 'Offenes Verbrennen', text: 'Notl√∂sung ‚Äì setzt Feinstaub, Black Carbon & CO‚ÇÇ frei.' },
    { icon: '‚òÅÔ∏è', title: 'Gesundheit & Klima', text: 'Luftverschmutzung & Klimawirkung ‚Äì √ºber dem Meer oft ‚Äûunsichtbar‚Äú.' },
  ] as FlowCard[],
  contextImage = { src: '/assets/Ladrilleros.png', alt: 'Ladrilleros K√ºstendorf' },
  contextChips = ['üìç ‚âà 60 min Boot von Buenaventura'],
  contextBullets = ['~100 kg Plastik t√§glich', 'Diesel ~35% teurer als in der Stadt', 'Kein geregeltes Abholsystem'],
  sectionId = 'problem',
} = Astro.props;
---

<section id={sectionId} class="relative py-16">
  <div class="mx-auto max-w-6xl px-6">
    <!-- Head -->
    <header class="mb-8">
      <h2 class="text-3xl md:text-4xl font-extrabold text-basola-brown" data-anim="fade-up">
        {heading}
      </h2>
      <p class="mt-3 text-lg text-basola-brown/80 max-w-3xl" data-anim="fade-up" data-anim-delay="80">
        {subline}
      </p>
    </header>

    <!-- KPIs -->
    <div class="grid gap-5 md:grid-cols-3" data-anim="fade-up" data-anim-delay="120">
      {kpis.map(k => (
        <div class="rounded-2xl bg-white shadow-sm ring-1 ring-black/5 p-6">
          <div class="text-4xl font-extrabold text-basola-yellow">
            <span id={k.id}>0</span>{k.suffix}
          </div>
          <div class="mt-2 text-sm uppercase tracking-wide text-basola-brown/70">{k.label}</div>
        </div>
      ))}
    </div>

    <!-- Flow cards -->
    <div class="mt-10 grid gap-5 md:grid-cols-3" data-anim="fade-up">
      {flow.map(c => (
        <div class="rounded-2xl bg-white shadow-sm ring-1 ring-black/5 p-6">
          <div class="text-3xl">{c.icon}</div>
          <div class="mt-2 font-semibold text-basola-brown">{c.title}</div>
          <p class="mt-1 text-basola-brown/80 text-sm">{c.text}</p>
        </div>
      ))}
    </div>

    <!-- Context: Bild + Chips -->
    <div class="mt-10 grid gap-6 md:grid-cols-5 items-center" data-anim="fade-up">
      <div class="md:col-span-3">
        <img src={contextImage.src} alt={contextImage.alt} class="rounded-2xl shadow-md w-full h-auto" />
      </div>
      <div class="md:col-span-2">
        <div class="flex flex-wrap gap-2">
          {contextChips.map((chip) => (
            <div class="inline-flex items-center gap-2 rounded-full border border-basola-yellow px-3 py-1.5 text-sm text-basola-brown bg-white/70">
              {chip}
            </div>
          ))}
        </div>
        <ul class="mt-4 space-y-2 text-basola-brown/85 list-disc list-inside">
          {contextBullets.map((b) => <li>{b}</li>)}
        </ul>
      </div>
    </div>
  </div>

  <!-- Animations (client) -->
  <script is:client>
    const ease = (t) => (--t) * t * t + 1;
    const animateNum = (el, to, dur = 1200) => {
      const start = performance.now();
      const step = (now) => {
        const p = Math.min(1, (now - start) / dur);
        el.textContent = Math.round(ease(p) * to).toLocaleString('de-DE');
        if (p < 1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    };

    const reveal = (root = document) => {
      root.querySelectorAll('[data-anim="fade-up"]').forEach((el) => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(10px)';
      });
      const io = new IntersectionObserver((entries) => {
        entries.forEach((e) => {
          if (e.isIntersecting) {
            const delay = Number(e.target.getAttribute('data-anim-delay') || 0);
            setTimeout(() => {
              e.target.style.transition = 'opacity 700ms, transform 700ms';
              e.target.style.opacity = '1';
              e.target.style.transform = 'translateY(0)';
            }, delay);
            io.unobserve(e.target);
          }
        });
      }, { threshold: 0.35 });
      root.querySelectorAll('[data-anim="fade-up"]').forEach((el) => io.observe(el));
    };

    const onceVisible = (sel, fn) => {
      const el = document.querySelector(sel);
      if (!el) return;
      const io = new IntersectionObserver((entries) => {
        entries.forEach((e) => {
          if (e.isIntersecting) {
            fn();
            io.disconnect();
          }
        });
      }, { threshold: 0.4 });
      io.observe(el);
    };

      onceVisible(`#${sectionId}`, () => {
        const ids = [
          { id: 'k1', to: ${'${kpis[0]?.value ?? 100}'} },
          { id: 'k2', to: ${'${kpis[1]?.value ?? 86}'} },
          { id: 'k3', to: ${'${kpis[2]?.value ?? 40}'} },
        ];
        ids.forEach(k => {
          const el = document.getElementById(k.id);
          if (el) animateNum(el, Number(k.to));
        });

        reveal(document.getElementById(sectionId));
      });

      reveal(document.getElementById(sectionId));
    </script>
  </section>

